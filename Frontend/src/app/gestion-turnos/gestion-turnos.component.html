<div class="table-container" *ngIf="horarios.length > 0" translate="no">
  <h2>Gesti√≥n de Turnos</h2>
  <table>
    <thead>
      <tr>
        <th>Horario</th>
        <th *ngFor="let dia of dias">
          <div>{{ dia.split(' ')[0] }}</div>
          <div>{{ dia.split(' ')[1] }}</div>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let hora of horas">
        <td class="hora-columna">{{ hora }}</td>
        <td *ngFor="let dia of dias">
                    
                    <!-- Celda d√≠a/hora -->
          <ng-container [ngSwitch]="estadoCierre(dia, hora)">

            <!-- ‚úÖ CERRADO FIJO: solo ‚ÄúEstudio cerrado‚Äù -->
            <ng-container *ngSwitchCase="'cerrado_fijo'">
              <div
                class="no-disponible feriado feriado-con-tip"
                title="Estudio cerrado."
                role="note"
                aria-label="Estudio cerrado."
              >
                <span class="feriado-label">Estudio cerrado</span>
                <!-- üëá SIN 'Se acredita recuperaci√≥n' -->
              </div>
            </ng-container>

            <!-- ‚úÖ AUSENCIA/FERIADO: mantiene ‚ÄúSe acredita recuperaci√≥n‚Äù -->
            <ng-container *ngSwitchCase="'ausencia'">
              <div
                class="no-disponible feriado feriado-con-tip"
                title="Estudio cerrado. Se acredita recuperaci√≥n."
                role="note"
                aria-label="Estudio cerrado. Se acredita recuperaci√≥n."
              >
                <span class="feriado-label">Estudio cerrado</span>
                <span class="badge-recupera">Se acredita recuperaci√≥n</span>
              </div>
            </ng-container>

            <!-- ‚úÖ ABIERTO NORMAL -->
            <ng-container *ngSwitchCase="'ninguno'">
              <ng-container *ngFor="let turno of getTurnos(dia, hora)">
                <div
                  class="clickeable {{ nivelCss(turno.nivel) }}"
                  (click)="abrirTurno(turno)"
                >
                  <div class="nivel">{{ turno.nivel }}</div>
                  <div class="reformers">
                    <strong>Reformers libres hoy: {{  libres(turno) }}</strong>
                  </div>
                  <div
                    class="reformers"
                    [ngClass]="{ 'reformers-fijos': disponiblesFijos(turno) > 0 }"
                  >
                    <strong>Turnos fijos disponibles: {{ disponiblesFijos(turno) }}</strong>
                  </div>


                  <!-- Reservas visibles -->
                  <div class="reservas" *ngIf="turno.reservas?.length > 0">
                    <div *ngFor="let r of turno.reservas">
                      <ng-container
                        *ngIf="esReservaVisibleEnCelda(r, turno) && (rolUsuario === 'admin' || turno.nivel.toLowerCase() === usuarioNivel.toLowerCase())"
                      >
                        <span
                          class="reserva-item"
                          [ngClass]="{
                            recup: r.tipo === 'recuperacion',
                            suelta: r.tipo === 'suelta',
                            'cancel-momentanea': esCancelacionMomentanea(r, turno)
                          }"
                        >
                          {{ r.nombre }} {{ r.apellido }}
                          <span *ngIf="esCancelacionMomentanea(r, turno)" class="badge-cancel" aria-label="Cancelaci√≥n moment√°nea">
                                (Cancel√≥)
                          </span>
                          <span *ngIf="r.tipo === 'recuperacion'" class="badge-recup" aria-label="Reserva de recuperaci√≥n">(Recup)</span>
                          <span *ngIf="r.tipo === 'suelta'" class="badge-suelta" aria-label="Clase suelta">(Suelta)</span>
                        </span>
                      </ng-container>
                    </div>
                  </div>

                  <!-- ‚úÖ Solo admin: controles de bloqueo -->
                  <div
                    *ngIf="rolUsuario === 'admin'"
                    class="bloqueo-controls"
                    style="margin-top:6px; display:flex; gap:8px; align-items:center; justify-content:center;"
                  >
                    <button
                      type="button"
                      (click)="$event.stopPropagation(); ajustarBloqueo(turno, -1)"
                      [disabled]="(turno.blockedReformers || 0) <= 0"
                    >‚àí</button>

                    <span><strong>Bloqueados:</strong> {{ turno.blockedReformers || 0 }}</span>

                    <button
                      type="button"
                      (click)="$event.stopPropagation(); ajustarBloqueo(turno, +1)"
                     
                       [disabled]="
                        ((turno.blockedReformers || 0) >=
                        max(0, (turno.totalReformers||0) -
                        ((turno.reformersReservados||0) || ocupadasEn((turno.id||turno.idHorario), turno.fecha))))
  "
                      >+</button>
                  </div>
                </div>
              </ng-container>
            </ng-container>

            <!-- Fallback sin turno -->
            <ng-container *ngSwitchDefault>
              <div class="no-disponible"> -- </div>
            </ng-container>
          </ng-container>

        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ‚úÖ MODAL PRINCIPAL: EDITAR TURNO -->
<div *ngIf="modalAbierto && !mostrarFormAgregar && !modalConfirmacionFinalAbierta && !mostrarModalTipoCancelacion" class="modal-overlay">
  <div class="modal-content">
    <h3>Editar Turno: {{ turnoSeleccionado.dia }} - {{ turnoSeleccionado.hora }}</h3>
    <p>Nivel: {{ turnoSeleccionado.nivel }}</p>

    <div *ngIf="turnoSeleccionado.reservas?.length > 0">
      <h4>Reservas actuales:</h4>
      <ul>
        <ng-container *ngFor="let r of turnoSeleccionado.reservas">
          <li>
            <span [ngStyle]="{ color: !r.automatica ? 'red' : 'inherit' }">
              {{ r.nombre }} {{ r.apellido }} <span *ngIf="!r.automatica">(Recup)</span>
            </span>
            <button class="btn-anular" (click)="abrirModalTipoCancelacion(r)">Anular</button>
          </li>
        </ng-container>
      </ul>
    </div>

    <div *ngIf="turnoSeleccionado.reservas?.length === 0">
      <p>No hay reservas a√∫n en este turno.</p>
    </div>

    <div class="botones-modal-principal">
      <button (click)="abrirFormAgregar()" class="btn-agregar-toggle">+ Agregar reserva para otro usuario</button>
      <button class="btn-cerrar" (click)="cerrarModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL PARA AGREGAR NUEVA RESERVA -->
<div *ngIf="mostrarFormAgregar && !modalConfirmacionFinalAbierta" class="modal-overlay is-tall">
  <div class="modal-content is-tall">
    <h3>Agregar nueva reserva</h3>
    <p>D√≠a: <strong>{{ turnoSeleccionado?.dia }}</strong></p>
    <p>Hora: <strong>{{ turnoSeleccionado?.hora }}</strong></p>
    <p>Nivel: <strong>{{ turnoSeleccionado?.nivel }}</strong></p>

    <label for="modoBusqueda">Buscar usuario por:</label>
    <select id="modoBusqueda" [(ngModel)]="busquedaModo">
      <option value="nombre-apellido">Nombre y Apellido</option>
      <option value="telefono">Tel√©fono</option>
    </select>

    <div *ngIf="busquedaModo === 'nombre-apellido'">
      <label><strong>Alumno:</strong></label>

      <!-- üîé Buscador -->
      <input
        type="text"
        [(ngModel)]="filtroAlumno"
        (ngModelChange)="aplicarFiltroAlumnos()"
        placeholder="Busc√° por apellido, nombre o tel√©fono‚Ä¶"
      />

      <!-- ‚úÖ Select filtrado -->
      <select
        [(ngModel)]="usuarioSeleccionadoId"
        (ngModelChange)="onSelectAlumno($event)">
        <option [ngValue]="null" disabled>Eleg√≠ un alumno‚Ä¶</option>
        <option *ngFor="let a of alumnosFiltrados" [ngValue]="a.id">
          {{ a.apellido | uppercase }}, {{ a.nombre }}
        </option>
      </select>
      <div *ngIf="alumnosFiltrados.length === 0" class="hint">
        No se encontraron alumnos para ‚Äú{{ filtroAlumno }}‚Äù.
      </div>
    </div>
    <div *ngIf="busquedaModo === 'telefono'">
      <input type="text" [(ngModel)]="telefonoNuevo" placeholder="Tel√©fono" />
    </div>

    <div class="form-group">
      <label for="tipoReserva"><strong>Tipo de reserva:</strong></label>
      <select id="tipoReserva" [(ngModel)]="tipoReserva">
        <option [ngValue]="'recuperacion'">Recuperaci√≥n</option>
        <option [ngValue]="'automatica'">Clase habitual (recurrente)</option>
        <option [ngValue]="'suelta'">Suelta / de prueba</option>
      </select>
    </div>

    <div class="modal-botones">
      <button class="btn-confirmar" (click)="abrirModalConfirmacionFinal()">Confirmar</button>
      <button class="btn-cerrar" (click)="cerrarFormAgregar()">Cancelar</button>
    </div>
    <div *ngIf="formMsg"
        [ngClass]="{ 'mensaje-bloqueo': formIsError, 'mensaje-ok': !formIsError }"
        role="alert">
      {{ formMsg }}
    </div>
  </div>
</div>

<!-- ‚úÖ NUEVO MODAL DE CONFIRMACI√ìN FINAL PARA RESERVAS (ADMIN) -->
<div *ngIf="modalConfirmacionFinalAbierta" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar nueva reserva</h3>
    <p>¬øEst√°s seguro de que quer√©s agregar la reserva?</p>
    <div class="modal-botones">
      <button class="btn-confirmar" (click)="confirmarReservaFinal()">‚úÖ S√≠, agregar</button>
      <button class="btn-cerrar" (click)="cerrarModalConfirmacionFinal()">‚ùå No</button>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL TIPO DE CANCELACI√ìN -->
<div *ngIf="mostrarModalTipoCancelacion" class="modal-overlay">
  <div class="modal-content">
    <h3>Tipo de cancelaci√≥n</h3>
    <p>¬øQuer√©s cancelar moment√°neamente o permanentemente la reserva de
      <strong>{{ reservaSeleccionada?.nombre }} {{ reservaSeleccionada?.apellido }}</strong>?</p>
    <div class="modal-botones">
      <button class="btn-confirmar" (click)="confirmarCancelacion('momentanea')">üïí Solo por esta vez</button>
      <button class="btn-confirmar" (click)="confirmarCancelacion('permanente')">‚ùå Cancelar permanentemente</button>
      <button class="btn-cerrar" (click)="cerrarModalTipoCancelacion()">üö´ Cerrar</button>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL CONFIRMACI√ìN FINAL DE CANCELACI√ìN -->
<div *ngIf="mostrarModalConfirmarAccion" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar cancelaci√≥n</h3>
      <p *ngIf="tipoCancelacionSeleccionado === 'momentanea'">
        ¬øQuer√©s cancelar la reserva del d√≠a <b>{{ turnoSeleccionado?.fecha }}</b>?
      </p>
      <p *ngIf="tipoCancelacionSeleccionado === 'permanente'">
        ¬øQuer√©s cancelar permanentemente la reserva de <b>{{ reservaSeleccionada.nombre }} {{ reservaSeleccionada.apellido }}</b>?
      </p>
    <p>{{ textoConfirmacion }}</p>
    <div class="modal-botones">
      <button class="btn-confirmar" (click)="ejecutarCancelacion()">‚úÖ S√≠, cancelar</button>
      <button class="btn-cerrar" (click)="cerrarModalConfirmarAccion()">‚ùå No</button>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL  PARA ALUMNO -->
<div *ngIf="modalAlumnoAbierto" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar Reserva</h3>
    <p><strong>Nombre:</strong> {{ nombreUsuario }}</p>
    <p><strong>Apellido:</strong> {{ apellidoUsuario }}</p>
    <p><strong>D√≠a:</strong> {{ turnoSeleccionado?.dia }}</p>
    <p><strong>Hora:</strong> {{ turnoSeleccionado?.hora }}</p>
    <p><strong>Nivel:</strong> {{ turnoSeleccionado?.nivel }}</p>
    <!-- Checklist para indicar si es una recuperaci√≥n -->
    <div class="form-group">
      <label for="tipoReserva"><strong>Tipo de reserva:</strong></label>
      <select id="tipoReserva" [(ngModel)]="tipoReserva" (change)="onCambioTipoReserva()" [disabled]="uiBloqueadoAlumno">
        <option [ngValue]="'recuperacion'">Recuperaci√≥n</option>
        <option [ngValue]="'automatica'">Clase habitual (recurrente)</option>
        <option [ngValue]="'suelta'">Suelta / de prueba</option>
      </select>
    </div>
    <div *ngIf="mensajeBloqueoRecuperacion && (tipoReserva === 'recuperacion' || tipoReserva==='suelta')" class="mensaje-bloqueo">
      {{ mensajeBloqueoRecuperacion }}
    </div>

    <button class="btn-confirmar"
        (click)="confirmarReserva()"
        [disabled]="tipoReserva !== 'automatica' && mensajeBloqueoRecuperacion">Confirmar</button>

    <button class="btn-cerrar" (click)="cerrarModalAlumno()">Cancelar</button>

    <div *ngIf="mostrarConfirmacion"
        [ngClass]="{'mensaje-confirmacion': true, 'success': !esErrorReserva, 'error': esErrorReserva}">
      {{ mensajeReserva }}
    </div>
  </div>
</div>
<!-- ‚úÖ MODAL ALERTA: TURNO EN EL PASADO -->
<div *ngIf="modalAlertaPasadoAbierto" class="modal-overlay">
  <div class="modal-content" style="max-width: 520px;">
    <h3>‚ö†Ô∏è Turno no v√°lido</h3>

    <p class="mensaje-bloqueo" style="margin-top: 10px;">
      {{ modalAlertaPasadoMsg }}
    </p>

    <div class="modal-botones">
      <button class="btn-confirmar" (click)="cerrarAlertaPasado()">OK</button>
    </div>
  </div>
</div>








