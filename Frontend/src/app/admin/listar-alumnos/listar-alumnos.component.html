<div class="table-container">
  <h2>Listado de Alumnos</h2>
  <div class="filtros-alumnos">
    <input type="text" [(ngModel)]="filtroApellido" placeholder="Buscar por apellido" />
    <input type="text" [(ngModel)]="filtroDni" placeholder="Buscar por DNI" />
    <input type="text" [(ngModel)]="filtroTelefono" placeholder="Buscar por tel√©fono" />
    <label class="filtro-checkbox is-compact">
      <input type="checkbox" [(ngModel)]="mostrarEmail" />
      Mostrar email
    </label>
    <label class="filtro-checkbox">
      <input type="checkbox" [(ngModel)]="mostrarInactivos" />
      Mostrar alumnos inactivos
    </label>
    <button class="nuevo-alumno-btn" (click)="irAFormularioRegistro()"> + Nuevo Alumno</button>
  </div>


  <table class="tabla-alumnos">
    <thead>
      <tr>
        <th>Apellido</th>
        <th>Nombre</th>
        <th>DNI</th>
        <th>Tel√©fono</th>
        <th *ngIf="mostrarEmail">Email</th>
        <th>Nivel</th>
        <th>Plan</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let alumno of alumnosFiltrados">

        <td>{{ alumno.apellido }}</td>
        <td>{{ alumno.nombre }}</td>
        <td>{{ alumno.dni }}</td>
        <td>{{ alumno.telefono }}</td>
        <td *ngIf="mostrarEmail">{{ alumno.email }}</td>
        <td>{{ alumno.nivel }}</td>
        <td>{{ alumno.planMensual }}</td>
        <td class="actions-cell">
          <button class="action-btn calendar-btn" (click)="verAsistencia(alumno.id, alumno.nombre, alumno.apellido)">
            üìÖ
          </button>
          <button
            class="btn-pago"
            *ngIf="esPagoVisible(alumno)"
            [ngClass]="{
              'pago-ok': alumno._pagoMesActual?.fase === 'ok',
              'pago-warn': alumno._pagoMesActual?.fase === 'warn',
              'pago-vencido': alumno._pagoMesActual?.fase === 'vencido'
            }"

            (click)="abrirPago(alumno)">
            $
          </button>
          <button class="action-btn" title="Historial de pagos"
                  (click)="verHistorialPagos(alumno)">
            üßæ
          </button>
          
          <button class="action-btn edit-btn" (click)="editarAlumno(alumno.id)">
            ‚úèÔ∏è
          </button>

          <!-- üîÅ Cambia √≠cono y acci√≥n seg√∫n el estado -->
          <button
            *ngIf="alumno.activo"
            class="action-btn delete-btn"
            (click)="inactivarAlumno(alumno.id)"
            title="Inactivar alumno"
          >
            üö´
          </button>
          <button
            *ngIf="!alumno.activo"
            class="action-btn reactivate-btn"
            type="button"
            (click)="onClickReactivar($event, alumno)"
            title="Reactivar alumno"
          >
            ‚ôªÔ∏è
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- MODAL para historial de pagos -->
<div *ngIf="historialOpen" class="modal-overlay">
  <div class="modal-content-asistencia" style="max-width: 720px;">
    <h3>Historial de pagos ‚Äî {{ historialAlumno?.apellido }} {{ historialAlumno?.nombre }}</h3>

    <table class="tabla-historial">
      <thead>
        <tr>
          <th>Mes/A√±o</th>
          <th>Fecha de pago</th>
          <th>Plan</th>
          <th>Monto</th>
          <th>M√©todo</th>
          <th>Notas</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let p of historialPagos">
          <td data-label="Mes/A√±o">{{ (p.mes && p.anio) ? (p.mes + '/' + p.anio) : '-' }}</td>
          <td data-label="Fecha de pago">{{ p.fechaPago | date:'dd/MM/yyyy HH:mm' }}</td>
          <td data-label="Plan">{{ p.planTipo }}</td>
          <td data-label="Monto">$ {{ p.montoARS }}</td>
          <td data-label="M√©todo">{{ p.metodo || '-' }}</td>
          <td data-label="Notas">{{ p.notas || '-' }}</td>
        </tr>

        <tr *ngIf="!historialPagos.length">
          <td colspan="6"><em>Sin pagos registrados.</em></td>
        </tr>
      </tbody>
    </table>

    <button class="btn-cerrar" (click)="cerrarHistorial()">Cerrar</button>
  </div>
</div>
  <!--  MODAL para confirmar inactivaci√≥n -->
<div *ngIf="modalConfirmacionInactivo" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar Inactivaci√≥n</h3>
    <p>¬øEst√°s seguro de que quer√©s marcar como inactivo a:</p>
    <p><strong>{{ alumnoSeleccionadoApellido }}, {{ alumnoSeleccionadoNombre }}</strong>?</p>
    <button class="btn-confirmar" (click)="confirmarInactivacion()">‚úÖ S√≠, inactivar</button>
    <button class="btn-cerrar" (click)="cerrarModalInactivacion()">Cancelar</button>
  </div>
</div>
<!--  MODAL para confirmar reactivaci√≥n -->
<div *ngIf="modalConfirmacionReactivar" class="modal-overlay">
  <div class="modal-content">
    <h3>Confirmar Reactivaci√≥n</h3>
    <p>¬øQuer√©s reactivar a:</p>
    <p><strong>{{ alumnoSeleccionadoApellido }}, {{ alumnoSeleccionadoNombre }}</strong>?</p>
    <button class="btn-confirmar" (click)="confirmarReactivacion()">‚úÖ S√≠, reactivar</button>
    <button class="btn-cerrar" (click)="cerrarModalReactivacion()">Cancelar</button>
  </div>
</div>
<!-- Modal asistencia -->
<div *ngIf="modalAsistencia" class="modal-overlay">
  <div class="modal-content-asistencia">
    <h3>
      Asistencias de<br />
      <span class="nombre-alumno">{{ asistenciaNombre }} {{ asistenciaApellido }}</span>
    </h3>

    <table class="tabla-asistencia">
      <thead>
        <tr>
          <th>Ciclo Actual</th>
          <th>Asistidas</th>
          <th>Recuperadas</th>
          <th>Canceladas</th>
          <th>Estudio Cerrado</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngIf="asistenciaCicloActual as ciclo; else sinCicloActual">
          <tr>
            <td>
              <div>
                {{ formatearFechaAR(ciclo.cicloInicio) }}
                ‚Üí
                {{ formatearFechaAR(ciclo.cicloFin || ciclo.finVentana) }}
              </div>

              <div class="sublinea">
                <em>
                  Clases del plan asistidas al d√≠a de hoy : 
                  {{ (ciclo.asistidas || 0) + (ciclo.recuperadas || 0) }}
                </em>
              </div>

              <div class="sublinea" *ngIf="ciclo.sueltas">
                <em>Clases sueltas en el ciclo: {{ ciclo.sueltas }}</em>
              </div>
            </td>

            <td>
              <div><strong>Total:</strong> {{ ciclo.asistidas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasAsistidas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasAsistidas)">
                  ‚Ä¢ {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <td>
              <div><strong>Total:</strong> {{ ciclo.recuperadas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasRecuperadas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasRecuperadas)">
                  ‚Ä¢ {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <td>
              <div><strong>Total:</strong> {{ ciclo.canceladas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasCanceladas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCanceladas)">
                  ‚Ä¢ {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <td>
              <div><strong>Total:</strong> {{ ciclo.cerrado ?? 0 }}</div>
              <div *ngIf="ciclo.fechasCerrado?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCerrado)">
                  ‚Ä¢ {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>
          </tr>
        </ng-container>

        <ng-template #sinCicloActual>
          <tr>
            <td colspan="5" style="text-align:center; padding: 14px;">
              <em>No hay ciclo activo todav√≠a.</em>
            </td>
          </tr>
        </ng-template>
      </tbody>
    </table>
    
    <div class="acciones-asistencia">
      <button class="btn-secundario" (click)="abrirHistorialCiclos()" [disabled]="!tieneHistorialFinalizado">
        Ver historial
      </button>

      <button class="btn-cerrar" (click)="cerrarModalAsistencia()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal historial de ciclos -->
<div *ngIf="modalHistorialCiclos" class="modal-overlay">
  <div class="modal-content-asistencia" style="max-width: 880px;">
    <h3>
      Historial de ciclos 
      <span class="nombre-alumno">{{ asistenciaNombre }} {{ asistenciaApellido }}</span>
    </h3>

    <div *ngFor="let bloque of historialPorAnio; trackBy: trackByAnio" class="bloque-anio">
      <h4 class="anio-titulo">{{ bloque.anio }}</h4>

      <div *ngFor="let ciclo of bloque.ciclos; trackBy: trackByCiclo" class="ciclo-card">
        
        <!-- HEADER DEL CICLO -->
        <div class="ciclo-header">
          <div class="ciclo-fechas">
            {{ formatearFechaAR(ciclo.cicloInicio) }}
            ‚Üí
            {{ formatearFechaAR(ciclo.cicloFin || ciclo.finVentana) }}
          </div>

          <button
            class="btn-toggle"
            (click)="toggleCiclo(ciclo)">
            {{ isCicloExpandido(ciclo) ? 'Ocultar detalle ‚ñ≤' : 'Ver detalle ‚ñº' }}
          </button>
        </div>

        <!-- RESUMEN -->
        <div class="ciclo-resumen">
          <span><strong>Asistidas:</strong> {{ ciclo.asistidas ?? 0 }}</span>
          <span><strong>Recup:</strong> {{ ciclo.recuperadas ?? 0 }}</span>
          <span><strong>Cancel:</strong> {{ ciclo.canceladas ?? 0 }}</span>
          <span><strong>Cerrado:</strong> {{ ciclo.cerrado ?? 0 }}</span>
          <span *ngIf="ciclo.sueltas"><strong>Sueltas:</strong> {{ ciclo.sueltas }}</span>
        </div>

        <!-- DETALLE EXPANDIDO -->
        <div *ngIf="isCicloExpandido(ciclo)" class="ciclo-detalle">

          <!-- ASISTIDAS -->
          <div class="detalle-col">
            <strong>Asistidas</strong>

            <ng-container *ngIf="ciclo.fechasAsistidas?.length; else noAsistidasTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasAsistidas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noAsistidasTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- RECUPERADAS -->
          <div class="detalle-col">
            <strong>Recuperadas</strong>

            <ng-container *ngIf="ciclo.fechasRecuperadas?.length; else noRecupTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasRecuperadas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noRecupTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- CANCELADAS -->
          <div class="detalle-col">
            <strong>Canceladas</strong>

            <ng-container *ngIf="ciclo.fechasCanceladas?.length; else noCancelTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCanceladas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noCancelTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- CERRADO -->
          <div class="detalle-col">
            <strong>Estudio cerrado</strong>

            <ng-container *ngIf="ciclo.fechasCerrado?.length; else noCerradoTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCerrado)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noCerradoTpl><em>‚Äî</em></ng-template>
          </div>


        </div>
      </div>
    </div>

    <button class="btn-cerrar" (click)="cerrarHistorialCiclos()">Cerrar</button>
  </div>
</div>


<app-pagos
  *ngIf="showPagoModal"
  [alumno]="modalAlumno!"
  [estado]="modalEstado!"
  [mes]="mesActual"
  [anio]="anioActual"
  (confirmar)="confirmarPago($event)"
  (eliminar)="eliminarPago($event)"
  (cerrar)="cerrarModal()">
</app-pagos>




