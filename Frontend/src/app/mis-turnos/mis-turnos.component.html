<div class="table-container" *ngIf="dias.length && horas.length" translate="no">
  <div class="titulo-con-boton">
    <h2>Mis turnos</h2>

    <button class="btn-asistencia"
            (click)="verMiAsistencia()">
      üìä VER MI ASISTENCIA
    </button>
  </div>

  <div *ngIf="avisoSemana as aviso" class="aviso-recuperacion-fijo">
    üîÅ Ten√©s {{ aviso.count }} {{ aviso.label }} esta semana.
  </div>

  <table class="tabla-turnos">
    <thead>
      <tr>
        <th>Horario</th>
        <th *ngFor="let dia of dias">
          <div>{{ dia.split(' ')[0] }}</div>
          <div>{{ dia.split(' ')[1] }}</div>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let hora of horas">
        <td class="hora-columna">{{ hora }}</td>
        <td *ngFor="let dia of dias">
          <ng-container *ngIf="!hayAusencia(dia, hora); else ausencia">
            <ng-container *ngIf="hasReserva(dia, hora); else sinTurno">
              <div class="clickeable"
                [ngClass]="[
                  nivelCss(getNivel(dia, hora)),
                  hasReserva(dia, hora) ? 'con-reserva' : '',
                  esRecuperacion(dia, hora) ? 'recuperacion' : '',
                  esSuelta(dia, hora) ? 'suelta' : '',
                  esCanceladaMomentanea(dia, hora) ? 'cancelada' : ''
                ]"

                [title]="esRecuperacion(dia, hora) ? 'Clase de recuperaci√≥n' : (esSuelta(dia, hora) ? 'Clase suelta' : 'Clase regular')"
                (click)="abrirModalDesdeCelda(dia, hora)">
                <div class="nivel"> {{ getNivel(dia, hora) }}</div>
                <div class="reformers">
                  {{ getNombreCompleto(dia, hora) }}
                  <span *ngIf="esRecuperacion(dia, hora)" class="badge-recup">(Recup)</span>
                  <span *ngIf="esSuelta(dia, hora)" class="badge-suelta">(Suelta)</span>
                  <span *ngIf="esCanceladaMomentanea(dia, hora)" class="badge-cancelada">(Cancelada)</span>

                </div>
              </div>
            </ng-container>
          </ng-container>
          <ng-template #ausencia>
            <div
              class="no-disponible feriado feriado-con-tip"
              title="Estudio cerrado. Se acredita recuperaci√≥n."
              role="note"
              aria-label="Estudio cerrado. Se acredita recuperaci√≥n."
            >
              <span class="feriado-label">Estudio cerrado</span>
              <span class="badge-recupera">Se acredita recuperaci√≥n</span>
            </div>
          </ng-template>
          <ng-template #sinTurno>
            <div class="no-disponible"> -- </div>
          </ng-template>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<!-- ‚úÖ MODAL PARA RESERVAS PERMANENTES -->
<div *ngIf="modalAbierto" class="modal-overlay">
  <div class="modal-content">
    <h3>¬øQuer√©s cancelar este turno?</h3>
    <p>
      D√≠a: <strong>{{ turnoAEliminar?.horario?.dia }}</strong><br>
      Hora: <strong>{{ turnoAEliminar?.horario?.hora }}</strong><br>
      Fecha: <strong>{{ formatearFechaArg(turnoAEliminar?.fechaTurno) }}</strong><br>
      Nivel: <strong>{{ turnoAEliminar?.horario?.nivel }}</strong>
    </p>

    <p>¬øC√≥mo quer√©s cancelarlo?</p>

    <div class="acciones-centradas">
      <button class="btn-cancelar"
              (click)="confirmarCancelacion('momentanea')"
              [disabled]="uiBloqueadoAlumnoCancel">üïí Solo por esta vez</button>

      <button class="btn-cancelar"
              (click)="confirmarCancelacion('permanente')"
              [disabled]="uiBloqueadoAlumnoCancel">‚ùå Cancelar permanentemente</button>

      <button class="btn-cerrar" (click)="cerrarModal()">üö´ Cerrar</button>
    </div>

    <!-- Mensaje si est√° bloqueado -->
    <p *ngIf="uiBloqueadoAlumnoCancel" class="text-danger">
      ‚ö†Ô∏è Solo se puede cancelar un turno hasta 2 horas antes de su inicio.
    </p>

    <!-- Zona de mensajes -->
    <div *ngIf="mostrarConfirmacionUsuario"
         [ngClass]="{'mensaje-confirmacion': true, 'success': !esErrorUsuarioCancel, 'error': esErrorUsuarioCancel}">
      {{ mensajeUsuarioCancel }}
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL PARA RESERVAS TEMPORALES -->
<div *ngIf="mostrarModalConfirmarAccion" class="modal-overlay">
  <div class="modal-content">
    <h3>{{ tituloConfirmacion }}</h3>
    <p>{{ textoConfirmacion }}</p>

    <div class="acciones-centradas">
      <button class="btn-confirmar" (click)="aceptarCancelacion()">‚úÖ S√≠, cancelar</button>
      <button class="btn-cerrar" (click)="cerrarConfirmacionFinal()">‚ùå No</button>
    </div>
  </div>
</div>
<!-- ‚úÖ MODAL DE RECUPERACIONES -->
<div *ngIf="mostrarModalRecuperacion" class="modal-overlay">
  <div class="modal-content">
    <h3>¬°Ten√©s {{ avisoSemana?.label || 'clases pendientes' }}!</h3>
    <p>
      Actualmente ten√©s <strong>{{ avisoSemana?.count }}</strong>
      {{ avisoSemana?.label }} pendiente{{ (avisoSemana?.count || 0) > 1 ? 's' : '' }}.
    </p>
    <div class="acciones-centradas">
      <button class="btn-confirmar" (click)="mostrarModalRecuperacion = false">Aceptar</button>
    </div>
  </div>
</div>
<!-- Modal asistencia  -->
<div *ngIf="modalAsistencia" class="modal-overlay">
  <div class="modal-content-asistencia">
    <h3>
      Asistencias de<br />
      <span class="nombre-alumno">{{ asistenciaNombre }} {{ asistenciaApellido }}</span>
    </h3>

    <table class="tabla-asistencia">
      <thead>
        <tr>
          <th>Ciclo Actual</th>
          <th>Asistidas</th>
          <th>Recuperadas</th>
          <th>Canceladas</th>
          <th>Estudio Cerrado</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngIf="asistenciaCicloActual as ciclo; else sinCicloActual">
          <tr>
            <!-- CICLO -->
            <td>
              <div>
                {{ formatearFechaAR(ciclo.cicloInicio) }}
                ‚Üí
                {{ formatearFechaAR(ciclo.cicloFin || ciclo.finVentana) }}
              </div>

              <div class="sublinea">
                <em>
                  Clases del plan asistidas al d√≠a de hoy:
                  {{ (ciclo.asistidas || 0) + (ciclo.recuperadas || 0) }}
                </em>
              </div>

              <div class="sublinea" *ngIf="ciclo.sueltas">
                <em>Clases sueltas en el ciclo: {{ ciclo.sueltas }}</em>
              </div>
            </td>

            <!-- ASISTIDAS -->
            <td>
              <div><strong>Total:</strong> {{ ciclo.asistidas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasAsistidas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasAsistidas)">
                  ‚Ä¢&nbsp; {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <!-- RECUPERADAS -->
            <td>
              <div><strong>Total:</strong> {{ ciclo.recuperadas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasRecuperadas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasRecuperadas)">
                  ‚Ä¢&nbsp; {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <!-- CANCELADAS -->
            <td>
              <div><strong>Total:</strong> {{ ciclo.canceladas ?? 0 }}</div>
              <div *ngIf="ciclo.fechasCanceladas?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCanceladas)">
                  ‚Ä¢&nbsp; {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>

            <!-- ESTUDIO CERRADO -->
            <td>
              <div><strong>Total:</strong> {{ ciclo.cerrado ?? 0 }}</div>
              <div *ngIf="ciclo.fechasCerrado?.length">
                <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCerrado)">
                  ‚Ä¢&nbsp; {{ formatearFechaAR(f) }}<br />
                </small>
              </div>
            </td>
          </tr>
        </ng-container>

        <ng-template #sinCicloActual>
          <tr>
            <td colspan="5" style="text-align:center; padding: 14px;">
              <em>No hay ciclo activo todav√≠a.</em>
            </td>
          </tr>
        </ng-template>
  
      </tbody>
    </table>
    <div class="acciones-asistencia">
      <button class="btn-secundario" (click)="abrirHistorialCiclos()" [disabled]="!tieneHistorialFinalizado">
        Ver historial
      </button>

      <button class="btn-cerrar" (click)="cerrarModalAsistencia()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal historial de ciclos -->
<div *ngIf="modalHistorialCiclos" class="modal-overlay">
  <div class="modal-content-asistencia" style="max-width: 880px;">
    <h3>
      Historial de ciclos 
      <span class="nombre-alumno">{{ asistenciaNombre }} {{ asistenciaApellido }}</span>
    </h3>

    <div *ngFor="let bloque of historialPorAnio; trackBy: trackByAnio" class="bloque-anio">
      <h4 class="anio-titulo">{{ bloque.anio }}</h4>

      <div *ngFor="let ciclo of bloque.ciclos; trackBy: trackByCiclo" class="ciclo-card">
        
        <!-- HEADER DEL CICLO -->
        <div class="ciclo-header">
          <div class="ciclo-fechas">
            {{ formatearFechaAR(ciclo.cicloInicio) }}
            ‚Üí
            {{ formatearFechaAR(ciclo.cicloFin || ciclo.finVentana) }}
          </div>

          <button
            class="btn-toggle"
            (click)="toggleCiclo(ciclo)">
            {{ isCicloExpandido(ciclo) ? 'Ocultar detalle ‚ñ≤' : 'Ver detalle ‚ñº' }}
          </button>
        </div>

        <!-- RESUMEN -->
        <div class="ciclo-resumen">
          <span><strong>Asistidas:</strong> {{ ciclo.asistidas ?? 0 }}</span>
          <span><strong>Recup:</strong> {{ ciclo.recuperadas ?? 0 }}</span>
          <span><strong>Cancel:</strong> {{ ciclo.canceladas ?? 0 }}</span>
          <span><strong>Cerrado:</strong> {{ ciclo.cerrado ?? 0 }}</span>
          <span *ngIf="ciclo.sueltas"><strong>Sueltas:</strong> {{ ciclo.sueltas }}</span>
        </div>

        <!-- DETALLE EXPANDIDO -->
        <div *ngIf="isCicloExpandido(ciclo)" class="ciclo-detalle">

          <!-- ASISTIDAS -->
          <div class="detalle-col">
            <strong>Asistidas</strong>

            <ng-container *ngIf="ciclo.fechasAsistidas?.length; else noAsistidasTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasAsistidas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noAsistidasTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- RECUPERADAS -->
          <div class="detalle-col">
            <strong>Recuperadas</strong>

            <ng-container *ngIf="ciclo.fechasRecuperadas?.length; else noRecupTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasRecuperadas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noRecupTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- CANCELADAS -->
          <div class="detalle-col">
            <strong>Canceladas</strong>

            <ng-container *ngIf="ciclo.fechasCanceladas?.length; else noCancelTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCanceladas)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noCancelTpl><em>‚Äî</em></ng-template>
          </div>

          <!-- CERRADO -->
          <div class="detalle-col">
            <strong>Estudio cerrado</strong>

            <ng-container *ngIf="ciclo.fechasCerrado?.length; else noCerradoTpl">
              <small *ngFor="let f of ordenarFechasAsc(ciclo.fechasCerrado)">
                ‚Ä¢ {{ formatearFechaAR(f) }}<br />
              </small>
            </ng-container>

            <ng-template #noCerradoTpl><em>‚Äî</em></ng-template>
          </div>


        </div>
      </div>
    </div>

    <button class="btn-cerrar" (click)="cerrarHistorialCiclos()">Cerrar</button>
  </div>
</div>

